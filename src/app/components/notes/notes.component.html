<div class="flex flex-col lg:flex-row lg:items-start gap-6">
  <details #newNotePanel class="w-full lg:w-80 bg-white rounded border">
    <summary class="cursor-pointer select-none px-4 py-3 font-semibold">Nouvelle note</summary>
    <form class="space-y-3 p-4 pt-2" (ngSubmit)="create()">
      <div>
        <label class="block text-sm text-gray-600 mb-1">Titre</label>
        <input [(ngModel)]="title" name="title" class="w-full px-3 py-2 border rounded" placeholder="Titre"/>
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">Contenu</label>
        <div class="flex flex-wrap items-center gap-2 mb-2 text-sm">
          <select class="px-2 py-1 border rounded"
                  [value]="toolbar.block"
                  (change)="format(getCurrentEditor(), 'formatBlock', $any($event.target).value); onEditorInput(getCurrentEditor())">
            <option value="P">Paragraphe</option>
            <option value="H1">Titre 1</option>
            <option value="H2">Titre 2</option>
            <option value="H3">Titre 3</option>
          </select>
          <button type="button" class="btn px-2 py-1 border rounded" [class.active]="toolbar.bold"
                  (click)="format(getCurrentEditor(),'bold'); onEditorInput(getCurrentEditor())"><b>B</b></button>
          <button type="button" class="btn px-2 py-1 border rounded italic" [class.active]="toolbar.italic"
                  (click)="format(getCurrentEditor(),'italic'); onEditorInput(getCurrentEditor())">I
          </button>
          <button type="button" class="btn px-2 py-1 border rounded" [class.active]="toolbar.strike"
                  (click)="format(getCurrentEditor(),'strikeThrough'); onEditorInput(getCurrentEditor())"><span
            class="line-through">S</span></button>
          <button type="button" class="btn px-2 py-1 border rounded" [class.active]="toolbar.ul"
                  (click)="format(getCurrentEditor(),'insertUnorderedList'); onEditorInput(getCurrentEditor())">• Liste
          </button>
          <button type="button" class="btn px-2 py-1 border rounded" [class.active]="toolbar.ol"
                  (click)="format(getCurrentEditor(),'insertOrderedList'); onEditorInput(getCurrentEditor())">1. Liste
          </button>
          <span class="mx-1 h-4 w-px bg-gray-300 inline-block align-middle"></span>
          <button type="button" class="btn px-2 py-1 border rounded" [class.active]="toolbar.link"
                  title="Insérer un lien"
                  (click)="insertLink(getCurrentEditor())">Lien</button>
          <button type="button" class="btn px-2 py-1 border rounded"
                  [disabled]="!toolbar.link"
                  title="Supprimer le lien"
                  (click)="unlink(getCurrentEditor())">Retirer lien</button>
        </div>
        <div
          #createEditor
          class="min-h-32 w-full px-3 py-2 border rounded focus:outline-none note-content max-w-none"
          contenteditable="true"
          (input)="onEditorInput(createEditor)"
          (keyup)="onEditorInput(createEditor)"
          (mouseup)="onEditorInput(createEditor)"
          (focus)="setActiveEditor('create')"
        ></div>
      </div>
      <button type="submit" class="px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Créer</button>
    </form>
  </details>

  <div class="flex-1 mt-6 lg:mt-0">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">Notes</h2>
      <button class="text-sm px-3 py-1 border rounded hover:bg-gray-50" (click)="refresh()">Rafraîchir</button>
    </div>

    <div class="grid gap-4">
      @for (n of notes(); track n.id) {
        <div class="border rounded p-4">
          @if (editingId === n.id) {
            <div class="space-y-3">
              <input [(ngModel)]="editTitle" name="editTitle" class="w-full px-3 py-2 border rounded" />
              <div class="flex flex-wrap items-center gap-2 mb-2 text-sm">
                <select class="px-2 py-1 border rounded"
                        [value]="toolbar.block"
                        (change)="format(getCurrentEditor(), 'formatBlock', $any($event.target).value); onEditorInput(getCurrentEditor())">
                  <option value="P">Paragraphe</option>
                  <option value="H1">Titre 1</option>
                  <option value="H2">Titre 2</option>
                  <option value="H3">Titre 3</option>
                </select>
                <button type="button" class="btn px-2 py-1 border rounded" [class.active]="toolbar.bold" (click)="format(getCurrentEditor(),'bold'); onEditorInput(getCurrentEditor())"><b>B</b></button>
                <button type="button" class="btn px-2 py-1 border rounded italic" [class.active]="toolbar.italic" (click)="format(getCurrentEditor(),'italic'); onEditorInput(getCurrentEditor())">I</button>
                <button type="button" class="btn px-2 py-1 border rounded" [class.active]="toolbar.strike" (click)="format(getCurrentEditor(),'strikeThrough'); onEditorInput(getCurrentEditor())"><span class="line-through">S</span></button>
                <button type="button" class="btn px-2 py-1 border rounded" [class.active]="toolbar.ul" (click)="format(getCurrentEditor(),'insertUnorderedList'); onEditorInput(getCurrentEditor())">• Liste</button>
                <button type="button" class="btn px-2 py-1 border rounded" [class.active]="toolbar.ol" (click)="format(getCurrentEditor(),'insertOrderedList'); onEditorInput(getCurrentEditor())">1. Liste</button>
                <span class="mx-1 h-4 w-px bg-gray-300 inline-block align-middle"></span>
                <button type="button" class="btn px-2 py-1 border rounded" [class.active]="toolbar.link" title="Insérer un lien" (click)="insertLink(getCurrentEditor())">Lien</button>
                <button type="button" class="btn px-2 py-1 border rounded" [disabled]="!toolbar.link" title="Supprimer le lien" (click)="unlink(getCurrentEditor())">Retirer lien</button>
              </div>
              <div
                #editEditor
                class="min-h-32 w-full px-3 py-2 border rounded focus:outline-none note-content max-w-none"
                contenteditable="true"
                (input)="onEditorInput(editEditor)"
                (keyup)="onEditorInput(editEditor)"
                (mouseup)="onEditorInput(editEditor)"
                (focus)="setActiveEditor('edit')"
              ></div>
              <div class="flex gap-2">
                <button class="px-3 py-1 rounded bg-blue-600 text-white" (click)="save(n.id)">Enregistrer</button>
                <button class="px-3 py-1 rounded border" (click)="cancel()">Annuler</button>
              </div>
            </div>
          } @else {
            <div class="note-row flex items-start sm:justify-between gap-2 sm:gap-4">
              <div class="note-body order-2 sm:order-1">
                <div class="font-medium">{{ n.title || '(Sans titre)' }}</div>
                <div class="note-content text-gray-700 mt-1" [innerHTML]="n.content"></div>
                <div class="text-xs text-gray-500 mt-2">Propriétaire: {{ n.ownerId }}</div>
              </div>
              <div class="note-actions order-1 sm:order-2 shrink-0 self-start flex items-center sm:items-start gap-2 mt-2 sm:mt-0">
                <button class="h-auto px-2 py-1 text-sm border rounded hover:bg-gray-50" (click)="startEdit(n.id, n.title, n.content)">Modifier</button>
                <button class="h-auto px-2 py-1 text-sm border rounded hover:bg-gray-50" (click)="remove(n.id)">Supprimer</button>
              </div>
            </div>
          }
        </div>
      }
      @empty {
        <div class="text-sm text-gray-500">Aucune note.</div>
      }
    </div>
  </div>
</div>


