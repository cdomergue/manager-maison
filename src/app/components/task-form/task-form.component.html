<form [formGroup]="taskForm" (ngSubmit)="onSubmit()" class="space-y-3">
  @let nameControl = taskForm.get("name");
  <!-- Nom de la t√¢che -->
  <div>
    <label for="name" class="block text-sm text-gray-600 dark:text-gray-300 mb-1"> Nom de la t√¢che * </label>
    <input
      id="name"
      type="text"
      formControlName="name"
      placeholder="Ex: Faire la vaisselle"
      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
      [ngClass]="{ 'border-red-500': nameControl?.invalid && nameControl?.touched }"
    />
    @if (nameControl?.invalid && nameControl?.touched) {
      <div class="text-red-500 text-sm mt-1">
        @if (nameControl?.errors?.["required"]) {
          <span>Le nom est requis</span>
        }
        @if (nameControl?.errors?.["minlength"]) {
          <span>Le nom doit contenir au moins 2 caract√®res</span>
        }
      </div>
    }
  </div>

  <!-- Description -->
  <div>
    <label for="description" class="block text-sm text-gray-600 dark:text-gray-300 mb-1">
      Description (optionnel)
    </label>
    <textarea
      id="description"
      formControlName="description"
      rows="3"
      placeholder="D√©tails suppl√©mentaires..."
      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
    ></textarea>
  </div>

  <!-- Cat√©gorie -->
  <div>
    <label for="category" class="block text-sm text-gray-600 dark:text-gray-300 mb-1"> Cat√©gorie </label>
    <select
      id="category"
      formControlName="category"
      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
    >
      <option value="">Aucune cat√©gorie</option>
      @for (category of categories; track category.id) {
        <option [value]="category.id">
          {{ category.name }}
        </option>
      }
    </select>
  </div>

  <!-- Fr√©quence -->
  <div>
    <label for="frequency" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"> Fr√©quence * </label>
    <select
      id="frequency"
      formControlName="frequency"
      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400"
    >
      @for (freq of frequencies; track freq.value) {
        <option [value]="freq.value">
          {{ freq.label }}
        </option>
      }
    </select>
  </div>

  <!-- Jours personnalis√©s -->
  @if (isCustomFrequency) {
    <div>
      <label for="customDays" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
        Nombre de jours entre chaque t√¢che
      </label>
      <input
        id="customDays"
        type="number"
        formControlName="customDays"
        min="1"
        max="365"
        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400"
      />
    </div>
  }

  <!-- R√®gle RRULE (optionnel) -->
  <div>
    <label for="rrule" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
      R√©currence avanc√©e (RRULE)
    </label>
    <input
      id="rrule"
      type="text"
      formControlName="rrule"
      placeholder="Ex: FREQ=WEEKLY;INTERVAL=2;BYDAY=MO"
      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400"
    />
    <p class="text-gray-500 dark:text-gray-400 text-xs mt-1">Si renseign√©, la RRULE prime sur la fr√©quence simple.</p>

    <details class="mt-2 group">
      <summary class="cursor-pointer select-none text-sm text-blue-700 dark:text-blue-400 hover:underline">
        Voir des exemples de RRULE
      </summary>
      <div
        class="mt-2 rounded-md border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 p-3 text-sm text-gray-700 dark:text-gray-300 space-y-2"
      >
        <p>
          Format RFC 5545 complet support√© : <strong>FREQ</strong>, <strong>INTERVAL</strong>, <strong>BYDAY</strong>,
          <strong>BYMONTH</strong>, <strong>BYMONTHDAY</strong>, <strong>COUNT</strong>, <strong>UNTIL</strong>, etc.
        </p>
        <ul class="list-disc pl-5 space-y-1">
          <li>
            Tous les jours:
            <code
              class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-500 px-1 py-0.5 rounded text-gray-900 dark:text-gray-100"
              >FREQ=DAILY</code
            >
          </li>
          <li>
            Un jour sur deux:
            <code
              class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-500 px-1 py-0.5 rounded text-gray-900 dark:text-gray-100"
              >FREQ=DAILY;INTERVAL=2</code
            >
          </li>
          <li>
            Tous les lundis:
            <code
              class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-500 px-1 py-0.5 rounded text-gray-900 dark:text-gray-100"
              >FREQ=WEEKLY;BYDAY=MO</code
            >
          </li>
          <li>
            Tous les lundis et jeudis:
            <code
              class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-500 px-1 py-0.5 rounded text-gray-900 dark:text-gray-100"
              >FREQ=WEEKLY;BYDAY=MO,TH</code
            >
          </li>
          <li>
            Un lundi sur deux:
            <code
              class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-500 px-1 py-0.5 rounded text-gray-900 dark:text-gray-100"
              >FREQ=WEEKLY;INTERVAL=2;BYDAY=MO</code
            >
          </li>
          <li>
            Toutes les 2 semaines (lundi et jeudi):
            <code
              class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-500 px-1 py-0.5 rounded text-gray-900 dark:text-gray-100"
              >FREQ=WEEKLY;INTERVAL=2;BYDAY=MO,TH</code
            >
          </li>
          <li>
            Jours ouvr√©s:
            <code
              class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-500 px-1 py-0.5 rounded text-gray-900 dark:text-gray-100"
              >FREQ=WEEKLY;BYDAY=MO,TU,WE,TH,FR</code
            >
          </li>
          <li>
            Tous les 15 du mois:
            <code
              class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-500 px-1 py-0.5 rounded text-gray-900 dark:text-gray-100"
              >FREQ=MONTHLY;BYMONTHDAY=15</code
            >
          </li>
          <li>
            Premier lundi de chaque mois:
            <code
              class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-500 px-1 py-0.5 rounded text-gray-900 dark:text-gray-100"
              >FREQ=MONTHLY;BYDAY=1MO</code
            >
          </li>
          <li>
            Quotidien pendant 10 occurrences:
            <code
              class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-500 px-1 py-0.5 rounded text-gray-900 dark:text-gray-100"
              >FREQ=DAILY;COUNT=10</code
            >
          </li>
        </ul>
        <p class="text-xs text-gray-500 dark:text-gray-400">
          Astuce: utilisez le champ "Exceptions" pour exclure des dates (jours f√©ri√©s, vacances, etc.).
        </p>
      </div>
    </details>
  </div>

  <!-- Dates d'exception (CSV) -->
  <div>
    <label for="exDates" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
      Exceptions (dates √† exclure)
    </label>
    <input
      id="exDates"
      type="text"
      formControlName="exDates"
      placeholder="YYYY-MM-DD, YYYY-MM-DD, ..."
      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400"
    />
    <p class="text-gray-500 dark:text-gray-400 text-xs mt-1">Dates exclues (jours f√©ri√©s, vacances, etc.).</p>
  </div>

  <!-- Priorit√© -->
  <div>
    <label for="priority" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"> Priorit√© * </label>
    <select
      id="priority"
      formControlName="priority"
      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400"
    >
      @for (priority of priorities; track priority.value) {
        <option [value]="priority.value">
          {{ priority.label }}
        </option>
      }
    </select>
  </div>

  <!-- Date d'√©ch√©ance -->
  <div>
    <div class="flex items-center justify-between mb-1">
      <label for="nextDueDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        Prochaine √©ch√©ance *
      </label>
      <button
        type="button"
        (click)="resetDateModificationFlag()"
        class="text-xs px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors"
        title="Recalculer automatiquement la date bas√©e sur la fr√©quence"
      >
        üîÑ Auto
      </button>
    </div>
    <input
      id="nextDueDate"
      type="date"
      formControlName="nextDueDate"
      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400"
      [ngClass]="{ 'border-red-500': taskForm.get('nextDueDate')?.invalid && taskForm.get('nextDueDate')?.touched }"
    />
    @if (taskForm.get("nextDueDate")?.invalid && taskForm.get("nextDueDate")?.touched) {
      <div class="text-red-500 text-sm mt-1">La date d'√©ch√©ance est requise</div>
    }
    @if (dateModifiedManually) {
      <p class="text-gray-500 text-xs mt-1">
        üìù Date modifi√©e manuellement. Cliquez sur "Auto" pour recalculer automatiquement.
      </p>
    }
  </div>

  <!-- Assign√© -->
  <div>
    <label for="assignee" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"> Assign√© </label>
    <select
      id="assignee"
      formControlName="assignee"
      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400"
    >
      <option value="">Aucun assign√©</option>
      @for (assignee of assignees; track assignee) {
        <option [value]="assignee">
          {{ assignee }}
        </option>
      }
    </select>
  </div>

  <!-- Boutons d'action -->
  <button
    type="submit"
    [disabled]="!isFormValid"
    class="px-3 py-2 rounded bg-blue-600 dark:bg-blue-600 text-white hover:bg-blue-700 dark:hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
  >
    {{ task() ? "Modifier" : "Cr√©er" }} la t√¢che
  </button>
</form>
